{% extends "base/base_dashboard.html" %}
{% load static %}

{% block title %}Equipe - Gestão de Usuários{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    .table th { border-top: none; font-weight: 600; color: #6B7280; font-size: 0.875rem; letter-spacing: 0.025em; padding-top: 1rem; padding-bottom: 1rem; }
    .table td { vertical-align: middle; }
    .avatar { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: 600; color: white; }
    .action-btn { width: 30px; height: 30px; border: 1px solid transparent; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
    .action-btn:hover { transform: translateY(-1px); }
    .form-control, .form-select { border: 1px solid #D1D5DB; border-radius: 10px; padding: 0.75rem 1rem; font-size: 0.875rem; }
    .form-control:focus, .form-select:focus { border-color: #7FB6F0; box-shadow: 0 0 0 3px rgba(127, 182, 240, 0.25); }
    .modal-content { border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.10), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    .modal-header, .modal-footer { border: none; }

    /* Cards compactos */
    .user-card-compact {
        background: white;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        padding: 0.75rem;
        transition: all 0.15s ease;
        margin-bottom: 0.5rem;
    }

    .user-card-compact:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.1);
        border-color: #7FB6F0;
    }

    .user-avatar-small {
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-weight: 600;
        color: white;
        font-size: 0.875rem;
    }

    .user-type-badge-small {
        font-size: 0.6875rem;
        font-weight: 500;
        padding: 0.125rem 0.5rem;
        border-radius: 12px;
        display: inline-block;
    }

    .user-type-VE { background-color: #E0F2FE; color: #0369A1; }
    .user-type-GE { background-color: #F0FDF4; color: #166534; }
    .user-type-CX { background-color: #FEF3C7; color: #92400E; }
    .user-type-CT { background-color: #FAE8FF; color: #7C2D92; }

    .group-header-compact {
        background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border-left: 4px solid #7FB6F0;
        margin-bottom: 0.75rem;
        margin-top: 1rem;
    }

    .filter-section {
        background: #F8F9FA;
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
    }

    .btn-check:checked + .btn-outline-primary {
        background-color: #7FB6F0;
        border-color: #7FB6F0;
        color: white;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }

    .status-active { background-color: #22C55E; }
    .status-inactive { background-color: #EF4444; }

    @media (max-width: 768px) {
        .filter-section .row {
            gap: 1rem;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        
        .btn-group .btn {
            flex: 1;
            min-width: auto;
        }
        
        .user-card-compact {
            padding: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card border-0 shadow-sm" style="border-radius: 16px;">
        <div class="card-header border-0 d-flex justify-content-between align-items-center"
             style="background: linear-gradient(135deg, #7FB6F0 0%, #BFD8FF 100%); color: #0F172A; border-radius: 16px 16px 0 0; padding: 1.5rem 2rem;">
            <h5 class="card-title mb-0 fw-semibold" style="color:#0F172A;"><i class="ti ti-users me-2"></i>Gestão de Usuários</h5>
            <button class="btn btn-light btn-sm px-3 py-2" onclick="openUserModal()" style="border-radius: 8px; font-weight: 600; color:#0F172A; border:1px solid rgba(15,23,42,.08);"><i class="ti ti-plus me-1"></i>Novo Usuário</button>
        </div>
        
        <div class="card-body">
            <!-- Filtros e Busca -->
            <div class="filter-section">
                <div class="row align-items-center g-3">
                    <div class="col-lg-8 col-md-12">
                        <label class="form-label fw-medium mb-2">Filtrar por tipo:</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="filterType" id="filterAll" value="all" checked>
                            <label class="btn btn-outline-primary btn-sm" for="filterAll">
                                <i class="ti ti-users me-1"></i>Todos (<span id="countAll">0</span>)
                            </label>
                            
                            <input type="radio" class="btn-check" name="filterType" id="filterVE" value="VE">
                            <label class="btn btn-outline-primary btn-sm" for="filterVE">
                                <i class="ti ti-briefcase me-1"></i>Vendedores (<span id="countVE">0</span>)
                            </label>
                            
                            <input type="radio" class="btn-check" name="filterType" id="filterGE" value="GE">
                            <label class="btn btn-outline-primary btn-sm" for="filterGE">
                                <i class="ti ti-crown me-1"></i>Gestores (<span id="countGE">0</span>)
                            </label>
                            
                            <input type="radio" class="btn-check" name="filterType" id="filterCX" value="CX">
                            <label class="btn btn-outline-primary btn-sm" for="filterCX">
                                <i class="ti ti-cash me-1"></i>Caixa (<span id="countCX">0</span>)
                            </label>
                            
                            <input type="radio" class="btn-check" name="filterType" id="filterCT" value="CT">
                            <label class="btn btn-outline-primary btn-sm" for="filterCT">
                                <i class="ti ti-calculator me-1"></i>Contábil (<span id="countCT">0</span>)
                            </label>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-12">
                        <label class="form-label fw-medium mb-2">Buscar usuário:</label>
                        <input type="text" class="form-control" id="searchUsers" placeholder="Digite nome ou email...">
                    </div>
                </div>
            </div>

            <!-- Lista Compacta de Usuários -->
            <div id="usersCompactList">
                <!-- Lista será inserida aqui via JavaScript -->
            </div>

            <!-- Estados de Loading e Empty -->
            <div id="loadingState" class="text-center p-5">
                <div class="spinner-border text-primary"></div>
                <p class="mt-3 text-muted">Carregando usuários...</p>
            </div>
            
            <div id="emptyState" class="text-center p-5 d-none">
                <i class="ti ti-user-off display-4 mb-3" style="color: #D1D5DB;"></i>
                <h6 style="color: #6B7280; font-weight: 600;">Nenhum usuário cadastrado</h6>
                <p style="color: #9CA3AF; font-size: 0.875rem;">Clique em "Novo Usuário" para começar</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal do Formulário -->
<div class="modal fade" id="userFormModal" tabindex="-1" aria-labelledby="userFormModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header" style="background: linear-gradient(135deg, #7FB6F0 0%, #BFD8FF 100%); color: #0F172A; border-radius: 16px 16px 0 0; padding: 1.25rem 1.75rem;">
                <h5 class="modal-title fw-semibold" id="userFormModalLabel">Novo Usuário</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="userForm">
                <div class="modal-body" style="padding: 2rem;">
                    <input type="hidden" id="userId" name="id">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-medium">Nome Completo</label>
                            <input type="text" id="first_name" name="first_name" class="form-control" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Nome de Usuário (para login)</label>
                            <input type="text" id="username" name="username" class="form-control" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Email</label>
                            <input type="email" id="email" name="email" class="form-control" required>
                        </div>
                        
                        <div class="col-md-12">
                            <label class="form-label fw-medium">Senha</label>
                            <input type="password" id="password" name="password" class="form-control" placeholder="Deixe em branco para não alterar">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Tipo de Usuário</label>
                            <select id="type_user" name="type_user" class="form-select" required>
                                <option value="VE">Vendedor</option>
                                <option value="CX">Caixa</option>
                                <option value="CT">Contábil</option>
                                <option value="GE">Gestor</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Documento (CPF/CNPJ)</label>
                            <input type="text" id="document" name="document" class="form-control" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Telefone</label>
                            <input type="text" id="phone" name="phone" class="form-control">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Data de Nascimento</label>
                            <input type="date" id="date_of_birth" name="date_of_birth" class="form-control">
                        </div>
                        
                        <div class="col-12 d-flex align-items-end">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="is_active" name="is_active" checked>
                                <label class="form-check-label" for="is_active">Usuário Ativo</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="background-color: #F9FAFB; border-radius: 0 0 16px 16px; padding: 1.25rem 1.75rem;">
                    <button type="button" class="btn px-4 py-2" data-bs-dismiss="modal" style="background-color: #F3F4F6; color: #111827; border-radius: 10px;">Cancelar</button>
                    <button type="submit" class="btn px-4 py-2" style="background-color: #7FB6F0; color: #0F172A; border-radius: 10px; font-weight: 700;">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <i class="ti ti-alert-circle text-danger display-4 mb-2"></i>
                <h5 class="fw-bold">Confirmar Exclusão</h5>
                <p class="text-muted">Tem certeza? Esta ação não pode ser desfeita.</p>
                <div class="d-flex justify-content-center gap-2 mt-3">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button id="confirmDeleteBtn" type="button" class="btn btn-danger">Excluir</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const API_URL = "/api/v1/users/";
let userFormModal, deleteUserModal;
let selectedUserId = null;
let allUsers = [];

const getCookie = name => document.cookie.match(`[; ]?${name}=([^;]*)`)?.[1] || null;
const CSRF_TOKEN = getCookie('csrftoken');
const TYPE_LABELS = { 'GE': 'Gestor', 'VE': 'Vendedor', 'CX': 'Caixa', 'CT': 'Contábil' };

// LÓGICA DE INICIAIS E NOME DE EXIBIÇÃO ATUALIZADA
const getInitials = (user) => {
    const fullName = (user.first_name || user.username || '').trim();
    const parts = fullName.split(' ').filter(p => p);
    if (parts.length > 1) {
        return `${parts[0][0]}${parts[parts.length - 1][0]}`.toUpperCase();
    }
    return fullName.substring(0, 2).toUpperCase() || '?';
};

const getDisplayName = (user) => (user.first_name || user.username).trim();

const showToast = (title, icon = 'success') => {
    Swal.fire({ title, icon, toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });
};

document.addEventListener("DOMContentLoaded", () => {
    userFormModal = new bootstrap.Modal(document.getElementById("userFormModal"));
    deleteUserModal = new bootstrap.Modal(document.getElementById("deleteUserModal"));
    loadUsers();
    document.getElementById("userForm").addEventListener("submit", handleFormSubmit);
    document.getElementById("confirmDeleteBtn").addEventListener("click", () => deleteUser(selectedUserId));
});

async function loadUsers() {
    const listContainer = document.getElementById("usersCompactList");
    const loading = document.getElementById("loadingState");
    const empty = document.getElementById("emptyState");
    
    listContainer.innerHTML = '';
    loading.classList.remove('d-none');
    empty.classList.add('d-none');

    try {
        const response = await fetch(API_URL);
        const users = await response.json();
        allUsers = users;
        
        if (users.length === 0) {
            empty.classList.remove('d-none');
        } else {
            renderUsersCompact(users);
            updateCounts(users);
            setupFilters();
            setupSearch();
        }
    } catch (error) {
        empty.innerHTML = `<div class="p-4 text-danger">Falha ao carregar dados.</div>`;
        empty.classList.remove('d-none');
    } finally {
        loading.classList.add('d-none');
    }
}

function renderUsersCompact(users) {
    const listContainer = document.getElementById("usersCompactList");
    
    // Agrupa usuários por tipo
    const groupedUsers = users.reduce((acc, user) => {
        if (!acc[user.type_user]) acc[user.type_user] = [];
        acc[user.type_user].push(user);
        return acc;
    }, {});

    let html = '';
    
    // Ordem de exibição dos tipos
    const typeOrder = ['GE', 'VE', 'CX', 'CT'];
    
    typeOrder.forEach(type => {
        if (groupedUsers[type]) {
            // Cabeçalho do grupo
            html += `
                <div class="group-header-compact group-section" data-group-type="${type}">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="ti ti-${getTypeIcon(type)} me-2"></i>
                            <strong>${TYPE_LABELS[type]}</strong>
                            <span class="ms-2 text-muted">(${groupedUsers[type].length})</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Lista de usuários do grupo
            groupedUsers[type].forEach(user => {
                const statusClass = user.is_active ? 'status-active' : 'status-inactive';
                const statusText = user.is_active ? 'Ativo' : 'Inativo';
                
                html += `
                    <div class="user-card-compact user-item" 
                         data-user-type="${user.type_user}"
                         data-user-name="${getDisplayName(user).toLowerCase()}"
                         data-user-email="${user.email ? user.email.toLowerCase() : ''}"
                         data-user-username="${user.username.toLowerCase()}">
                        <div class="d-flex align-items-center">
                            <div class="user-avatar-small me-3" style="background-color: #7FB6F0;">
                                ${getInitials(user)}
                            </div>
                            
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <h6 class="mb-0 fw-semibold" style="font-size: 0.9rem;">${getDisplayName(user)}</h6>
                                        <div class="d-flex align-items-center mt-1">
                                            <small class="text-muted me-3">@${user.username}</small>
                                            <span class="user-type-badge-small user-type-${user.type_user}">${TYPE_LABELS[user.type_user]}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="d-none d-md-block">
                                            <small class="text-muted d-block">${user.email || 'Sem email'}</small>
                                            <small class="text-muted">${user.phone || 'Sem telefone'}</small>
                                        </div>
                                        
                                        <div class="d-flex align-items-center">
                                            <span class="status-dot ${statusClass} me-2"></span>
                                            <small class="text-muted">${statusText}</small>
                                        </div>
                                        
                                        <div class="d-flex gap-1">
                                            <button class="action-btn btn btn-outline-primary btn-sm" onclick="openUserModal(${user.id})" title="Editar">
                                                <i class="ti ti-edit" style="font-size: 0.875rem;"></i>
                                            </button>
                                            <button class="action-btn btn btn-outline-danger btn-sm" onclick="openDeleteModal(${user.id})" title="Excluir">
                                                <i class="ti ti-trash" style="font-size: 0.875rem;"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
    });
    
    listContainer.innerHTML = html;
}

function getTypeIcon(type) {
    const icons = {
        'GE': 'crown',
        'VE': 'briefcase', 
        'CX': 'cash',
        'CT': 'calculator'
    };
    return icons[type] || 'user';
}

function updateCounts(users) {
    const counts = users.reduce((acc, user) => {
        acc[user.type_user] = (acc[user.type_user] || 0) + 1;
        return acc;
    }, {});
    
    document.getElementById('countAll').textContent = users.length;
    document.getElementById('countGE').textContent = counts.GE || 0;
    document.getElementById('countVE').textContent = counts.VE || 0;
    document.getElementById('countCX').textContent = counts.CX || 0;
    document.getElementById('countCT').textContent = counts.CT || 0;
}

// Função para filtros
function setupFilters() {
    const filterButtons = document.querySelectorAll('input[name="filterType"]');
    filterButtons.forEach(btn => {
        btn.addEventListener('change', () => {
            const filterValue = btn.value;
            const items = document.querySelectorAll('.user-item');
            const groups = document.querySelectorAll('.group-section');
            
            if (filterValue === 'all') {
                items.forEach(item => item.style.display = 'block');
                groups.forEach(group => group.style.display = 'block');
            } else {
                items.forEach(item => {
                    if (item.dataset.userType === filterValue) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                groups.forEach(group => {
                    if (group.dataset.groupType === filterValue) {
                        group.style.display = 'block';
                    } else {
                        group.style.display = 'none';
                    }
                });
            }
        });
    });
}

// Função para busca
function setupSearch() {
    const searchInput = document.getElementById('searchUsers');
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.user-item');
        
        items.forEach(item => {
            const name = item.dataset.userName;
            const email = item.dataset.userEmail;
            const username = item.dataset.userUsername;
            
            if (name.includes(searchTerm) || email.includes(searchTerm) || username.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    });
}

async function openUserModal(userId = null) {
    const form = document.getElementById("userForm");
    form.reset();
    const modalTitle = document.getElementById("userFormModalLabel");
    const passwordInput = document.getElementById("password");
    
    modalTitle.textContent = "Novo Usuário";
    passwordInput.placeholder = "Senha forte";
    passwordInput.required = true;
    document.getElementById('userId').value = '';

    if (userId) {
        modalTitle.textContent = "Editar Usuário";
        passwordInput.placeholder = "Deixe em branco para não alterar";
        passwordInput.required = false;

        try {
            const response = await fetch(`${API_URL}${userId}/`);
            if (!response.ok) throw new Error('Usuário não encontrado');
            const user = await response.json();
            
            document.getElementById('userId').value = user.id;
            document.getElementById('first_name').value = user.first_name || '';
            document.getElementById('username').value = user.username || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('type_user').value = user.type_user || 'VE';
            document.getElementById('document').value = user.document || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('date_of_birth').value = user.date_of_birth || '';
            document.getElementById('is_active').checked = user.is_active;

        } catch (error) {
            showToast(`Erro ao carregar dados: ${error.message}`, "error");
            return;
        }
    }
    userFormModal.show();
}

function openDeleteModal(userId) {
    selectedUserId = userId;
    deleteUserModal.show();
}

async function handleFormSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const userId = form.elements.id.value;
    const method = userId ? "PATCH" : "POST";
    const url = userId ? `${API_URL}${userId}/` : API_URL;

    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());
    
    if (userId && !payload.password) delete payload.password;
    if (!userId) delete payload.id;
    payload.is_active = document.getElementById('is_active').checked;

    try {
        const response = await fetch(url, { 
            method, 
            headers: { 
                "Content-Type": "application/json", 
                "X-CSRFToken": CSRF_TOKEN 
            }, 
            body: JSON.stringify(payload) 
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            const errorMessage = Object.entries(errorData).map(([field, errors]) => `${field.replace("_", " ")}: ${errors.join(', ')}`).join('; ');
            throw new Error(errorMessage);
        }

        showToast(userId ? "Usuário atualizado com sucesso!" : "Usuário cadastrado com sucesso!");
        userFormModal.hide();
        loadUsers();
    } catch (error) {
        showToast(`Erro: ${error.message}`, "error");
    }
}

async function deleteUser(userId) {
    try {
        const response = await fetch(`${API_URL}${userId}/`, {
            method: "DELETE",
            headers: { "X-CSRFToken": CSRF_TOKEN }
        });

        if (!response.ok) throw new Error('Falha ao excluir usuário');

        showToast("Usuário excluído com sucesso!");
        deleteUserModal.hide();
        loadUsers();
    } catch (error) {
        showToast(`Erro: ${error.message}`, "error");
    }
}
</script>
{% endblock %}